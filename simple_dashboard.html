<!DOCTYPE html>
<html>
<head>
    <title>BenBot Simple Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .positive {
            color: green;
        }
        .negative {
            color: red;
        }
        .status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-up {
            background-color: #d4edda;
            color: #155724;
        }
        .status-down {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BenBot Trading Dashboard</h1>
            <div>
                <span id="broker-status" class="status status-up">Broker: UP</span>
                <span id="data-status" class="status status-up">Data: UP</span>
                <span id="last-update"></span>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Account Balance</h2>
                <div id="account-balance">
                    <p>Equity: <span id="equity">$0.00</span></p>
                    <p>Cash: <span id="cash">$0.00</span></p>
                    <p>Day P/L: <span id="day-pl">$0.00 (0.00%)</span></p>
                </div>
            </div>

            <div class="card">
                <h2>Market Context</h2>
                <div id="market-context">
                    <p>Regime: <span id="regime">Unknown</span></p>
                    <p>Volatility: <span id="volatility">Unknown</span></p>
                    <p>Sentiment: <span id="sentiment">Unknown</span></p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Positions</h2>
            <table id="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Qty</th>
                        <th>Avg Price</th>
                        <th>Last</th>
                        <th>P/L $</th>
                        <th>P/L %</th>
                    </tr>
                </thead>
                <tbody id="positions-body">
                    <!-- Positions will be added here -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Open Orders</h2>
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Qty</th>
                        <th>Type</th>
                        <th>Limit Price</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="orders-body">
                    <!-- Orders will be added here -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Active Strategies</h2>
            <table id="strategies-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Exposure %</th>
                        <th>P/L (30d)</th>
                    </tr>
                </thead>
                <tbody id="strategies-body">
                    <!-- Strategies will be added here -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Recent Signals</h2>
            <table id="signals-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Strategy</th>
                        <th>Symbol</th>
                        <th>Action</th>
                        <th>Size</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="signals-body">
                    <!-- Signals will be added here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'http://localhost:3002';

        // Function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        // Function to format percentage
        function formatPercent(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        }

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString();
        }

        // Function to fetch API data
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        // Update health status
        async function updateHealth() {
            const data = await fetchAPI('/health');
            if (data) {
                document.getElementById('broker-status').textContent = `Broker: ${data.broker}`;
                document.getElementById('broker-status').className = `status status-${data.broker === 'UP' ? 'up' : 'down'}`;
                
                document.getElementById('data-status').textContent = `Data: ${data.data}`;
                document.getElementById('data-status').className = `status status-${data.data === 'UP' ? 'up' : 'down'}`;
                
                document.getElementById('last-update').textContent = `Last update: ${formatDate(data.last_heartbeat)}`;
            }
        }

        // Update account balance
        async function updateAccount() {
            const data = await fetchAPI('/api/v1/account/balance');
            if (data) {
                document.getElementById('equity').textContent = formatCurrency(data.equity);
                document.getElementById('cash').textContent = formatCurrency(data.cash);
                
                const plElement = document.getElementById('day-pl');
                plElement.textContent = `${formatCurrency(data.day_pl_dollar)} (${data.day_pl_pct.toFixed(2)}%)`;
                plElement.className = data.day_pl_dollar >= 0 ? 'positive' : 'negative';
            }
        }

        // Update market context
        async function updateContext() {
            const data = await fetchAPI('/context');
            if (data && data.success && data.data) {
                document.getElementById('regime').textContent = data.data.regime || 'Unknown';
                document.getElementById('volatility').textContent = data.data.volatility || 'Unknown';
                document.getElementById('sentiment').textContent = data.data.sentiment || 'Unknown';
            }
        }

        // Update positions
        async function updatePositions() {
            const data = await fetchAPI('/api/v1/positions');
            if (data) {
                const tbody = document.getElementById('positions-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6">No positions</td>';
                    tbody.appendChild(row);
                } else {
                    data.forEach(position => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${position.symbol}</td>
                            <td>${position.qty}</td>
                            <td>${formatCurrency(position.avg_price)}</td>
                            <td>${formatCurrency(position.last)}</td>
                            <td class="${position.pl_dollar >= 0 ? 'positive' : 'negative'}">${formatCurrency(position.pl_dollar)}</td>
                            <td class="${position.pl_pct >= 0 ? 'positive' : 'negative'}">${position.pl_pct.toFixed(2)}%</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            }
        }

        // Update orders
        async function updateOrders() {
            const data = await fetchAPI('/api/v1/orders/open');
            if (data) {
                const tbody = document.getElementById('orders-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7">No open orders</td>';
                    tbody.appendChild(row);
                } else {
                    data.forEach(order => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.id}</td>
                            <td>${order.symbol}</td>
                            <td>${order.side}</td>
                            <td>${order.qty}</td>
                            <td>${order.type}</td>
                            <td>${order.limit_price ? formatCurrency(order.limit_price) : 'N/A'}</td>
                            <td>${order.status}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            }
        }

        // Update strategies
        async function updateStrategies() {
            const data = await fetchAPI('/api/v1/strategies');
            if (data) {
                const tbody = document.getElementById('strategies-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4">No strategies</td>';
                    tbody.appendChild(row);
                } else {
                    data.forEach(strategy => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${strategy.name}</td>
                            <td>${strategy.active ? 'Active' : 'Inactive'}</td>
                            <td>${(strategy.exposure_pct * 100).toFixed(2)}%</td>
                            <td class="${strategy.p_l_30d >= 0 ? 'positive' : 'negative'}">${formatCurrency(strategy.p_l_30d)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            }
        }

        // Update signals
        async function updateSignals() {
            const data = await fetchAPI('/api/v1/signals/live');
            if (data) {
                const tbody = document.getElementById('signals-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6">No signals</td>';
                    tbody.appendChild(row);
                } else {
                    data.forEach(signal => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(signal.ts)}</td>
                            <td>${signal.strategy}</td>
                            <td>${signal.symbol}</td>
                            <td>${signal.action}</td>
                            <td>${signal.size}</td>
                            <td>${signal.reason}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            }
        }

        // Update all data
        async function updateAllData() {
            await updateHealth();
            await updateAccount();
            await updateContext();
            await updatePositions();
            await updateOrders();
            await updateStrategies();
            await updateSignals();
        }

        // Initial load
        updateAllData();

        // Refresh data every 5 seconds
        setInterval(updateAllData, 5000);
    </script>
</body>
</html>
